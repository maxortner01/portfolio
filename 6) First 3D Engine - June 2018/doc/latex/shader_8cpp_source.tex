\section{shader.\+cpp}
\label{shader_8cpp_source}\index{src/engine/controllers/shader.\+cpp@{src/engine/controllers/shader.\+cpp}}

\begin{DoxyCode}
00001 \textcolor{preprocessor}{#include "shader.h"}
00002 
00003 \textcolor{keyword}{inline} \textcolor{keywordtype}{bool} Controllers::Shader::fileExists(std::string filename) \{
00004     std::ifstream f(filename);
00005     \textcolor{keywordflow}{return} f.good();
00006 \}
00007 
00008 std::string Controllers::Shader::readFile(std::string filename) \{
00009     std::string line, end;
00010 
00011     std::ifstream infile(filename);
00012     \textcolor{keywordflow}{while} ( std::getline(infile, line) ) \{
00013         end += line + \textcolor{stringliteral}{"\(\backslash\)n"};
00014     \}
00015 
00016     \textcolor{keywordflow}{return} end;
00017 \}
00018 
00019 Controllers::Shader::Shader(std::string shadername) \{
00020     std::cout << \textcolor{stringliteral}{"\(\backslash\)nCreating shader: "} << shadername << std::endl;
00021 
00022     \textcolor{comment}{//by default the shader is to read the shader file}
00023     std::string directory        = \textcolor{stringliteral}{"src/engine/shaders/"};
00024     std::string shaderNames  [2] \{ directory + \textcolor{stringliteral}{"shader.vert.glsl"}, directory + \textcolor{stringliteral}{"shader.frag.glsl"} \};
00025     
00026     \textcolor{comment}{//add directory to shadername}
00027     shadername = directory + shadername;
00028 
00029     \textcolor{comment}{//set shader contents to default shader names}
00030     std::string shaderContent[2] \{ 
00031         readFile(shaderNames[VERTEX]),
00032         readFile(shaderNames[FRAGMENT])
00033     \};
00034 
00035     \textcolor{comment}{//VERTEX:   name and contents}
00036     \textcolor{keywordflow}{if} ( fileExists(shadername + \textcolor{stringliteral}{".vert.glsl"}) ) \{
00037         shaderNames  [VERTEX]   = shadername + \textcolor{stringliteral}{".vert.glsl"};
00038         shaderContent[VERTEX]   = readFile(shadername + \textcolor{stringliteral}{".vert.glsl"});
00039     \}
00040 
00041     \textcolor{comment}{//FRAGMENT: name and contents}
00042     \textcolor{keywordflow}{if} ( fileExists(shadername + \textcolor{stringliteral}{".frag.glsl"}) ) \{
00043         shaderNames  [FRAGMENT] = shadername + \textcolor{stringliteral}{".frag.glsl"};
00044         shaderContent[FRAGMENT] = readFile(shadername + \textcolor{stringliteral}{".frag.glsl"});
00045     \}
00046 
00047     \textcolor{comment}{//Create shader and program}
00048     program  = glCreateProgram();
00049     vertex   = glCreateShader(GL\_VERTEX\_SHADER);
00050     fragment = glCreateShader(GL\_FRAGMENT\_SHADER);
00051 
00052     std::cout << \textcolor{stringliteral}{"  Program  ID: "} << program << std::endl;
00053     std::cout << \textcolor{stringliteral}{"  Vertex   ID: "} << vertex << std::endl;
00054     std::cout << \textcolor{stringliteral}{"  Fragment ID: "} << fragment << std::endl;
00055 
00056     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* v = shaderContent[VERTEX].c\_str();
00057     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* f = shaderContent[FRAGMENT].c\_str();
00058 
00059     \textcolor{comment}{//Set shader source}
00060     glShaderSource(vertex,   1, &v, NULL);
00061     glShaderSource(fragment, 1, &f, NULL);
00062 
00063     \textcolor{comment}{//Compile shaders}
00064     glCompileShader(vertex);
00065     glCompileShader(fragment);
00066 
00067     \textcolor{comment}{//Error checking for shaders}
00068     GLint status;
00069     glGetShaderiv(vertex, GL\_COMPILE\_STATUS, &status);
00070     \textcolor{keywordflow}{if} ( !status ) \{
00071         GLchar infoLog[BUFF\_SIZE];
00072         glGetShaderInfoLog(vertex, BUFF\_SIZE, NULL, infoLog);
00073 
00074         std::cout << \textcolor{stringliteral}{"Error in vertex compilation!"} << std::endl;
00075         std::cout << \textcolor{stringliteral}{"Info log:"} << infoLog << std::endl;
00076     \}
00077 
00078     glGetShaderiv(fragment, GL\_COMPILE\_STATUS, &status);
00079     \textcolor{keywordflow}{if} ( !status ) \{
00080         GLchar infoLog[BUFF\_SIZE];
00081         glGetShaderInfoLog(fragment, BUFF\_SIZE, NULL, infoLog);
00082 
00083         std::cout << \textcolor{stringliteral}{"Error in fragment compilation!"} << std::endl;
00084         std::cout << \textcolor{stringliteral}{"Info log: "} << infoLog << std::endl;
00085     \}
00086     
00087     \textcolor{comment}{//Attach shader to program}
00088     glAttachShader(program, vertex);
00089     glAttachShader(program, fragment);
00090 
00091     \textcolor{comment}{//Create attributes}
00092     glBindAttribLocation(program, 0, \textcolor{stringliteral}{"vertices"});
00093 
00094     \textcolor{comment}{//Link and validate program}
00095     glLinkProgram(program);
00096 
00097     glGetProgramiv(program, GL\_LINK\_STATUS, &status);
00098     \textcolor{keywordflow}{if} ( !status ) \{
00099         GLchar infoLog[BUFF\_SIZE];
00100         glGetProgramInfoLog(program, BUFF\_SIZE, NULL, infoLog);
00101 
00102         std::cout << \textcolor{stringliteral}{"Error in program linkage!"} << std::endl;
00103         std::cout << \textcolor{stringliteral}{"Info log: "} << infoLog << std::endl;
00104     \}
00105 
00106     glValidateProgram(program);
00107 
00108     glGetProgramiv(program, GL\_VALIDATE\_STATUS, &status);
00109     \textcolor{keywordflow}{if} ( !status ) \{
00110         GLchar infoLog[BUFF\_SIZE];
00111         glGetProgramInfoLog(program, BUFF\_SIZE, NULL, infoLog);
00112 
00113         std::cout << \textcolor{stringliteral}{"Error in program validation!"} << std::endl;
00114         std::cout << \textcolor{stringliteral}{"Info log: "} << infoLog << std::endl;
00115     \}
00116 \}
00117 
00118 \textcolor{keywordtype}{void} Controllers::Shader::setMatrix(glm::mat4 matrix) \{
00119     \textcolor{keywordtype}{int} location = glGetUniformLocation(program, \textcolor{stringliteral}{"matrix"});
00120 
00121     \textcolor{comment}{//matrix->setScale(new vert3f(.5, .5, 0));}
00122     \textcolor{comment}{//matrix->rotate(new vert3f(.2, .3, 0));}
00123 
00124 
00125     \textcolor{comment}{/*float floats[16] = \{0\};}
00126 \textcolor{comment}{    for (int y = 0; y < 4; y++) \{}
00127 \textcolor{comment}{        for (int x = 0; x < 4; x++) \{}
00128 \textcolor{comment}{            floats[(y * 4) + x] = matrix->get(x, y);}
00129 \textcolor{comment}{        \}}
00130 \textcolor{comment}{    \} */}
00131 
00132     glUniformMatrix4fv(location, 1, GL\_FALSE, glm::value\_ptr(matrix));
00133 \}
00134 
00135 \textcolor{keywordtype}{void} Controllers::Shader::setUniform(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* name, \textcolor{keyword}{const} \textcolor{keywordtype}{float} value) \{
00136     \textcolor{keywordtype}{int} location = glGetUniformLocation(program, name);
00137     glUniform1f(location, value);
00138 \}
\end{DoxyCode}
